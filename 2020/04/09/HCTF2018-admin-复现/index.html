<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style-dark.css?v=2.0.4"><link rel="stylesheet" type="text/css" href="/css/highlight-dark.css?v=2.0.4"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><title>HCTF2018 admin 复现 | Jabberwocky's blog</title><meta name="generator" content="Hexo 4.1.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">HCTF2018 admin 复现</h1><a id="logo" href="/.">Jabberwocky's blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="search"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">HCTF2018 admin 复现</h1><div class="post-meta"><a href="/2020/04/09/HCTF2018-admin-%E5%A4%8D%E7%8E%B0/#comments" class="comment-count"></a><p><span class="date">Apr 09, 2020</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Hits</i></i></span></p></div><div class="post-content"><h3 id="session-详细了解"><a href="#session-详细了解" class="headerlink" title="session 详细了解"></a>session 详细了解</h3><p>学习的博客：<a href="https://blog.csdn.net/h19910518/article/details/79348051" target="_blank" rel="noopener">https://blog.csdn.net/h19910518/article/details/79348051</a> 写的真是好</p>
<blockquote>
<p>session_start()<br>这是个无任何返回值的函数，既不会报错，也不会成功。它的作用是开启session，并随机生成一个唯一的32位的session_id，类似于这样：<br>4c83638b3b0dbf65583181c2f89168ec</p>
</blockquote>
<p>每次我们访问一个页面，如果有开启session，也就是有session_start() 时，就会自动生成一个session_id 来标注是这次会话的唯一ID，同时也会自动往cookie里写入一个名字为PHPSESSID的变量，它的值正是session_id，当这次会话没结束，再次访问的时候，服务器会去读取这个PHPSESSID的cookie是否有值有没过期，如果能够读取到，则继续用这个session_id，如果没有，就会新生成一个session_id，同时生成PHPSESSID这个cookie。由于默认生成的这个PHPSESSID cookie是会话，也就是说关闭浏览器就会过期掉，所以，下次重新浏览时，会重新生成一个session_id。</p>
<p>session 一般存贮在服务器端的\tmp目录下，同样也是用到session_id。session_id是32位的，服务器会用 sess_前缀 + session_id 的形式存在这个临时目录下<br>每一次生成的session_id都会生成一个这样的文件，用来保存这次会话的session信息。<br>例如<br>sess_bjvlo4p38cfqkr1hr7pe924ts3 这样的文件名</p>
<h3 id="往session文件中写数据"><a href="#往session文件中写数据" class="headerlink" title="往session文件中写数据:"></a>往session文件中写数据:</h3><p>例如<br>$_SESSION[‘hello’] = 123;<br>$_SESSION[‘word’] = 456;</p>
<p>数据存放形式为：hello|i:123;word|i:456;<br>是序列化的数据，我们肉眼也能读出来。当我们往$_SESSION全局变量里写数据时，它会自动往这个文件里写入。读取session的时候，也会根据session_id 找到这个文件，然后读取需要的session变量。</p>
<p>大致总结:</p>
<blockquote>
<p>HTTP请求一个页面后，如果用到开启session，会去读cookie中的PHPSESSID是否有，如果没有，则会新生成一个session_id，先存入cookie中的PHPSESSID中，再生成一个sess_前缀文件。当有写入$_SESSION的时候，就会往sess_文件里序列化写入数据。当读取的session变量的时候，先会读取cookie中的PHPSESSID，获得session_id，然后再去找这个sess_sessionid文件，来获取对应的数据。由于默认的PHPSESSID是临时的会话，在浏览器关闭后，会消失，所以，我们重新访问的时候，会新生成session_id和sess_这个文件。</p>
</blockquote>
<h3 id="有关session的几个变量-SID-session-id-COOKIE-“PHPSESSID”"><a href="#有关session的几个变量-SID-session-id-COOKIE-“PHPSESSID”" class="headerlink" title="有关session的几个变量 SID,session_id(),$_COOKIE[“PHPSESSID”]"></a>有关session的几个变量 SID,session_id(),$_COOKIE[“PHPSESSID”]</h3><blockquote>
<p>SID 是一个系统常量，SID包含着会话名以及会话 ID 的常量，格式为 “name=ID”，或者如果会话 ID 已经在适cookie 中设定时则为空字符串，第一次显示的时候输出的是SID的值，当你刷新的时候，因为已经在cookie中存在，所以显示的是一个空字符串。<br>session_id() 函数用来返回当前会话的session_id，它会去读取cookie中的name，也就是PHPSESSID值。</p>
</blockquote>
<h3 id="session的相关配置"><a href="#session的相关配置" class="headerlink" title="session的相关配置"></a>session的相关配置</h3><blockquote>
<p>[Session]<br>session.save_handler = files<br>session.save_path = “d:/wamp/tmp”<br>session.use_cookies = 1<br>session.name = PHPSESSID<br>session.auto_start = 0<br>session.cookie_lifetime = 0<br>session.serialize_handler = php<br>session.gc_divisor = 1000<br>session.gc_probability = 1<br>session.gc_maxlifetime = 1440</p>
</blockquote>
<p><strong>session.save_handler = files 表示的是session的存储方式，默认的是files文件的方式保存，sess_efdsw34534efsdfsfsf3r3wrresa, 保存在 session.save_path = “d:/wamp/tmp” 里，所有这2个都是可配值得。我们上面的例子就是用的这种默认的方式。</strong></p>
<p><strong>save_handler 不仅仅只能用文件files，还可以用我们常见的memcache 和 redis 来保存。</strong></p>
<p><strong>session.use_cookies 默认是1，表示会在浏览器里创建值为PHPSESSID的session_id，session.name = PHPSESSID 找个配置就是改这个名字的，你可以改成PHPSB, 那这样就再浏览器里生成名字为PHPSB的session_id 。</strong></p>
<p><strong>session.auto_start = 0 用来是否需要自动开启session，默认是不开启的，所有我们需要在代码中用到session_start();函数开启，如果设置成1，那么session_id 也会自动就生成了。</strong></p>
<p><strong>session.cookie_lifetime = 0 这个是设置在客户端生成PHPSESSID这个cookie的过期时间，默认是0，也就是关闭浏览器就过期，下次访问，会再次生成一个session_id。所以，如果想关闭浏览器会话后，希望session信息能够保持的时间长一点，可以把这个值设置大一点，单位是秒。</strong></p>
<p>复现学习的博客：<a href="https://www.jianshu.com/p/f92311564ad0" target="_blank" rel="noopener">https://www.jianshu.com/p/f92311564ad0</a></p>
<h3 id="解法一-flask-session伪造"><a href="#解法一-flask-session伪造" class="headerlink" title="解法一 flask session伪造"></a>解法一 flask session伪造</h3><p>说是复现，其实对flask一点都不了解，好像以buuok上的题来当web入门好像有点拉跨，不过看都看了，硬学下去吧</p>
<h3 id="什么是flask"><a href="#什么是flask" class="headerlink" title="什么是flask"></a>什么是flask</h3><p>学习的博客：<a href="https://www.cnblogs.com/mrchige/p/6387674.html" target="_blank" rel="noopener">https://www.cnblogs.com/mrchige/p/6387674.html</a></p>
<blockquote>
<p>Flask 是一个 web 框架。也就是说 Flask 为你提供工具，库和技术来允许你构建一个 web 应用程序。这个 wdb 应用程序可以使一些 web 页面、博客、wiki、基于 web 的日历应用或商业网站。<br>Flask 属于微框架（micro-framework）这一类别，微架构通常是很小的不依赖于外部库的框架。这既有优点也有缺点，优点是框架很轻量，更新时依赖少，并且专注安全方面的 bug，缺点是，你不得不自己做更多的工作，或通过添加插件增加自己的依赖列表。</p>
</blockquote>
<h3 id="解法一-伪造flask-session"><a href="#解法一-伪造flask-session" class="headerlink" title="解法一 伪造flask session"></a>解法一 伪造flask session</h3><p>学习的博客：<a href="https://www.jianshu.com/p/f92311564ad0" target="_blank" rel="noopener">https://www.jianshu.com/p/f92311564ad0</a></p>
<p>进入页面右上角可以login和register，先随便注册一个然后登录<br>登录之后可以change password，转到那个页面查看页面源码可以发现泄露了源码<br>之后去查看源码<br>先进去APP文件夹 -&gt; 查看route.py 看app.route()主要的文件有哪些 先查看index.html的内容<br>![image][tmp6]</p>
<p>发现只要以admin身份登录就可以拿到flag，回到注册页面注册admin会发现用户已被注册<br>而flask的session是存放在cookie中的，也就是存放在浏览器上，那么就有了可能伪造session的思路</p>
<p>要伪造session还需要知道签名，去github的源码导出看看有没有签名，最后在config.py中发现了签名<br>![image][tmp7]</p>
<p>拿到签名后还需要解密加密flask脚本，在google中可以搜索到<br><a href="https://github.com/noraj/flask-session-cookie-manager" target="_blank" rel="noopener">https://github.com/noraj/flask-session-cookie-manager</a></p>
<p>下载后开始伪造session：</p>
<ol>
<li>先解密，得到解密之前的数据，将当前用户名改成admin<br>这里有python2和python3两个脚本，用python3失败了，用python2成功了<blockquote>
<p>python2 flask_session_cookie_manager2.py decode -s “ckj123” -c “.eJw9kEGLwjAQhf_KkrOH2tKL4GEltSjMQJdoyVzEbWvTSeNCq2gj_vfNuuBhYOA9Pt57D3E4Dc1oxOIyXJuZOHS1WDzEx7dYCM2m176Kwa86lNkEsu8g3zLKdiKVeV0WKZa7iGR7I7nviHsDvPNawQ0cWSg3HrhKw2_Qf1nMswl9EaPPElDgQZIjXhmtqonyXaq5CEzqQYVzm0h7iFFtmeTakCzuwXcHvzZQ6gS5D5n-_GtLarMUz5moxuF0uPzY5vyuALJmUm2qfRYhk4N875CrBD11wPauYx2TyxJSK4sqxGI7x8_lC9e5Y9u8SftzKHr7V85HFwRxHOuTmInr2Ayv2cQ8Es9f9Y5uyQ.Xo82lg.zGqI1MszM160rzt9fWR5-0DFJDU”</p>
</blockquote>
</li>
</ol>
<p>-s 后跟签名<br>-c 后跟当前cookie的value<br>解密后的数据:<br>![image][tmp8]</p>
<ol start="2">
<li>将修改后的数据再进行加密伪造session<blockquote>
<p>python2 flask_session_cookie_manager2.py encode -s “ckj123” -t “ckj123” -t “{u’csrf_token’: ‘07ce89c1466f0ef67776b291cf6fa7e0d5172954’, u’user_id’: u’10’, u’name’: u’admin’, u’image’: ‘Vu4g’, u’_fresh’: True, u’_id’: ‘b8ec7630b41209b0bc482e13ad95e4d80d5bf9a253a302fd1b32792fa74d4a274671713306ff0aa72de9b43afe16e2b4c3652cd1ad41a7131a1f769b443aade2’}”</p>
</blockquote>
</li>
</ol>
<p>加密后的数据:<br>![image][tmp9]</p>
<p>之后再把这个伪造的session覆盖点当前的session的value就可以拿到flag了</p>
</div><div class="post-copyright"><blockquote><p>Original author: Jabberwocky</p><p>Original link: <a href="http://wafuter.jxustctf.top/2020/04/09/HCTF2018-admin-复现/">http://wafuter.jxustctf.top/2020/04/09/HCTF2018-admin-复现/</a></p><p>Copyright Notice: Please indicate the source of the reprint (must retain the author's signature and link)</p></blockquote></div><div class="tags"></div><div class="post-share"><div class="social-share"><span>Share:</span></div></div><div class="post-nav"><a href="/2020/04/08/buuoj%20web%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95%E4%BA%8C/" class="next">buuoj web刷题记录二</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Contents</i></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#session-详细了解"><span class="toc-text">session 详细了解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#往session文件中写数据"><span class="toc-text">往session文件中写数据:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#有关session的几个变量-SID-session-id-COOKIE-“PHPSESSID”"><span class="toc-text">有关session的几个变量 SID,session_id(),$_COOKIE[“PHPSESSID”]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#session的相关配置"><span class="toc-text">session的相关配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解法一-flask-session伪造"><span class="toc-text">解法一 flask session伪造</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是flask"><span class="toc-text">什么是flask</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解法一-伪造flask-session"><span class="toc-text">解法一 伪造flask session</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/04/09/HCTF2018-admin-%E5%A4%8D%E7%8E%B0/">HCTF2018 admin 复现</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/08/buuoj%20web%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95%E4%BA%8C/">buuoj web刷题记录二</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/07/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95%E4%B8%80/">buuoj刷题记录一</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/03/dvwa1-10%E5%AD%A6%E4%B9%A0%E4%B9%8Bsql%E7%9B%B2%E6%B3%A8/">dvwa1.10学习之sql盲注</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/31/DVWA1.10%E5%AD%A6%E4%B9%A0%E4%B9%8Bsql%E6%B3%A8%E5%85%A5/">DVWA1.10学习之sql注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/30/DVWA1.10%E5%AD%A6%E4%B9%A0%E4%B9%8BXSS/">DVWA1.10学习之XSS</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/17/Hgame-Eggplant-note-write-up/">Hgame Eggplant_note write up</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/14/2019%E6%8A%A4%E7%BD%91%E6%9D%AF-flower%E5%A4%8D%E7%8E%B0/">2019护网杯 flower复现</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/13/unlink%E5%8E%9F%E7%90%86-%E5%88%9D%E6%AD%A5%E7%90%86%E8%A7%A3/">结合2019 省赛题目 lllheap 对unlink的初步理解</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/10/XCTF-%E6%96%B0%E6%98%A5%E6%88%98%E7%96%AB-woodenbox2-writeup-easyheap-%E5%A4%8D%E7%8E%B0/">XCTF 新春战疫 woodenbox2 writeup && easyheap 复现</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"><a href="/tags/XSS-DVWA/" style="font-size: 15px;">XSS, DVWA</a> <a href="/tags/PWN-XMAN-2019/" style="font-size: 15px;">PWN, XMAN_2019</a> <a href="/tags/buuoj-PWN/" style="font-size: 15px;">buuoj, PWN</a> <a href="/tags/PWN-buuoj/" style="font-size: 15px;">PWN, buuoj</a> <a href="/tags/dvwa1-10-sql%E7%9B%B2%E6%B3%A8/" style="font-size: 15px;">dvwa1.10, sql盲注</a> <a href="/tags/Netword-Programming/" style="font-size: 15px;">Netword Programming</a> <a href="/tags/unlink/" style="font-size: 15px;">unlink</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E5%97%85%E6%8E%A2/" style="font-size: 15px;">网络嗅探</a> <a href="/tags/Hgame2020%EF%BC%8C-chunk-overlap/" style="font-size: 15px;">Hgame2020， chunk overlap</a> <a href="/tags/PWN-Hgame/" style="font-size: 15px;">PWN, Hgame</a> <a href="/tags/PWN%EF%BC%8CHgame2020/" style="font-size: 15px;">PWN，Hgame2020</a> <a href="/tags/ssti%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" style="font-size: 15px;">ssti模板注入</a> <a href="/tags/sql%E6%B3%A8%E5%85%A5%EF%BC%8CDVWA1-10/" style="font-size: 15px;">sql注入，DVWA1.10</a> <a href="/tags/wireshark%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%EF%BC%8C-ARP%E6%AC%BA%E9%AA%97%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/" style="font-size: 15px;">wireshark基本操作， ARP欺骗原理与实践</a> <a href="/tags/unsorted-bin-attack-%E4%BF%AE%E6%94%B9global-max-fast/" style="font-size: 15px;">unsorted bin attack, 修改global_max_fast</a> <a href="/tags/pwn-off-by-one/" style="font-size: 15px;">pwn, off-by-one</a> <a href="/tags/ret2dl-reslove-%E7%BB%95%E8%BF%87canary/" style="font-size: 15px;">ret2dl-reslove, 绕过canary</a> <a href="/tags/IO-2-1-stdout-fast-bin/" style="font-size: 15px;">IO_2_1_stdout, fast bin</a> <a href="/tags/tcache-struct-attack/" style="font-size: 15px;">tcache struct attack</a> <a href="/tags/2019%E6%8A%A4%E7%BD%91%E6%9D%AF%EF%BC%8C-malloc-consolidate/" style="font-size: 15px;">2019护网杯， malloc_consolidate</a> <a href="/tags/PWN/" style="font-size: 15px;">PWN</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archive</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">24</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> Blogroll</i></div><ul></ul><a href="https://0xcreed.jxustctf.top/" title="0xCreed" target="_blank">0xCreed</a><ul></ul><a href="http://www.example2.com/" title="null" target="_blank"></a><ul></ul><a href="http://www.example3.com/" title="null" target="_blank"></a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Site Map</a> |  <a href="/atom.xml">Subscribe to this site</a> |  <a href="/about/">Contact the blogger</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">Jabberwocky.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/" target="_blank" rel="noopener"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.4"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  }
});</script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML" async></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.4" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>